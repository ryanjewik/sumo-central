user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    keepalive_timeout  65;

    # SSL
    ssl_certificate /etc/ssl/sumopedia/origin-cert.pem;
    ssl_certificate_key /etc/ssl/sumopedia/origin-key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;
    add_header Referrer-Policy no-referrer-when-downgrade;

    # handle websocket Upgrade/Connection mapping
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # Upstream routing
    upstream frontend_upstream {
        server react-frontend:3000;
    }

    upstream backend_upstream {
        server gin-backend:8080;
    }

    upstream airflow_upstream {
        server airflow-webserver:8080;
    }

    server {
        listen 80;
        server_name sumopedia.net www.sumopedia.net;
        # Redirect all to HTTPS
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name sumopedia.net www.sumopedia.net;

        # Authenticated Origin Pulls (Cloudflare):
        # To enable strict origin-only access from Cloudflare, upload the
        # Cloudflare Origin Pull CA to /etc/ssl/sumopedia/cloudflare-origin-pull-ca.pem
        # on the host and mount it into the proxy container. Then uncomment the
        # two lines below (ssl_client_certificate and ssl_verify_client on) to
        # require Cloudflare to present a client certificate for origin requests.
        # NOTE: enabling client cert verification will reject direct requests to
        # the origin unless Cloudflare is configured to present the client cert.
        # ssl_client_certificate /etc/ssl/sumopedia/cloudflare-origin-pull-ca.pem;
        # ssl_verify_client on;

        # Root -> frontend
        location / {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://frontend_upstream;
        }

        # API -> Gin backend
        location /api/ {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            # Strip the /api/ prefix when proxying to the backend so backend
            # handlers don't need to include the /api prefix in their routes.
            # The trailing slash is important: location /api/ + proxy_pass .../;
            # rewrites /api/foo -> /foo when forwarded.
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            proxy_pass http://backend_upstream/;
        }

        # Webhook path
        location /webhook {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            proxy_pass http://backend_upstream;
        }

        # Airflow
            location /airflow/ {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://airflow_upstream;
            proxy_set_header X-Script-Name /airflow;
        }

            # Websocket endpoint for match updates (preserve Upgrade/Connection)
            location ~ ^/matches/.*/ws$ {
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                # use the mapped connection header variable for upgrade handling
                proxy_set_header Connection $connection_upgrade;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_buffering off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
                # For regex locations proxy_pass must not include a URI part
                proxy_pass http://backend_upstream;
            }

        # Static assets caching (example)
        location ~* \.(?:css|js|jpg|jpeg|gif|png|svg|ico|woff2?)$ {
            proxy_pass http://frontend_upstream;
            expires 30d;
            add_header Cache-Control "public";
        }
    }
}
